---
- name: Deleting /opt/cni/bin directory
  file:
    path: /opt/cni/bin
    state: absent

- name: Deleting /etc/cni/net.d directory
  file:
    path: /etc/cni/net.d
    state: absent

- name: Running ifdown weave
  shell: "ifconfig weave down"

- name: Running ip link delete weave
  shell: "ip link delete weave"

- name: Stopping kubelet
  service:
    name: kubelet
    state: stopped

- name: Cleaning up iptables rules
  shell: "iptables -F && iptables -t nat -F && iptables -t mangle -F && iptables -X"

- name: Resetting the IPVS tables
  shell: "ipvsadm -C"

- name: Starting kubelet
  service:
    name: kubelet
    state: started

- name: Running systemctl daemon-reload
  shell: "systemctl daemon-reload"

- name: Running systemctl daemon-reload
  shell: "systemctl restart kubelet"

- name: Recreating all pods
  become_user: "{{ ansible_user }}"
  shell: "for ns in $(kubectl get ns -o name | cut -f 2 -d '/'); do kubectl delete pods -n $ns --all; done"
